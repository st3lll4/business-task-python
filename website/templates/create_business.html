{% extends "base.html" %}
{% block title %}Create a business{% endblock %}

{% block content %}
    <div class="container-fluid h-25 bg-white text-center mb-4">
        <h1>Enter details for the new business</h1>
        {% with messages = get_flashed_messages() %}
            {% if messages %}
                {% for message in messages %}
                    <div class="alert alert-danger">{{ message }}</div>
                {% endfor %}
            {% endif %}
        {% endwith %}
    </div>

    <div class="container">
        <form method="post" id="createBusinessForm">
            {{ form.csrf_token }}

            <div class="row mb-3 justify-content-center">
                <label for="business_name" class="col-sm-2 col-form-label text-end fw-bold">Name</label>
                <div class="col-sm-3">
                    {{ form.business_name(class="form-control") }}
                    {% if form.business_name.errors %}
                        <div class="text-danger">{{ form.business_name.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 justify-content-center">
                <label for="registry_code" class="col-sm-2 col-form-label text-end fw-bold">Registry code</label>
                <div class="col-sm-3">
                    {{ form.registry_code(class="form-control") }}
                    {% if form.registry_code.errors %}
                        <div class="text-danger">{{ form.registry_code.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 justify-content-center">
                <label for="founding_date" class="col-sm-2 col-form-label text-end fw-bold">Founding date</label>
                <div class="col-sm-3">
                    {{ form.founding_date(class="form-control") }}
                    {% if form.founding_date.errors %}
                        <div class="text-danger">{{ form.founding_date.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <div class="row mb-3 justify-content-center">
                <label for="total_capital" class="col-sm-2 col-form-label text-end fw-bold">Total capital</label>
                <div class="col-sm-3">
                    {{ form.total_capital(class="form-control") }}
                    {% if form.total_capital.errors %}
                        <div class="text-danger">{{ form.total_capital.errors[0] }}</div>
                    {% endif %}
                </div>
            </div>

            <div id="shareholders-container">
                <div class="row mb-3 justify-content-center shareholder-entry">
                    <label class="col-sm-2 col-form-label text-end fw-bold">Shareholder</label>
                    <div class="col-sm-3">
                        <select class="form-control mb-2" name="shareholders[]">
                            {% for value, label in shareholders_list %}
                                <option value="{{ value }}">{{ label }}</option>
                            {% endfor %}
                        </select>
                        <input type="number" class="form-control" name="shares[]"
                               placeholder="Number of shares" min="1"/>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col text-center">
                    <button type="button" class="btn btn-secondary" id="addShareholderBtn">Add shareholder</button>
                    <button type="submit" class="btn btn-dark">Create</button>
                </div>
            </div>
        </form>
    </div>
{% endblock %}

{% block scripts %}
    <script>
        const addShareholderBtn = document.getElementById("addShareholderBtn");
        const shareholdersContainer = document.getElementById("shareholders-container");

        addShareholderBtn.addEventListener("click", (event) => {
            event.preventDefault();
            addShareholder();
            // update
        });

        const totalCapitalInput = document.getElementById("total_capital");
        const shareholderEntry = document.getElementById("shareholder-entry");
        let availableShares = parseInt(totalCapitalInput.value) || 0;

        function updateShares() {
            //todo
        }

        totalCapitalInput.addEventListener("change", (event) => {
            availableShares = parseInt(event.target.value); // || 0 ??
            updateShares();
        })

        function createShareholderEntry() {
            const entryDiv = document.createElement("div"); // main div
            entryDiv.className = "row mb-3 justify-content-center shareholder-entry";

            const label = document.createElement("label");
            label.className = "col-sm-2 col-form-label text-end fw-bold";
            label.textContent = "Shareholder";

            const controlsDiv = document.createElement("div"); // container for controls
            controlsDiv.className = "col-sm-3";

            entryDiv.appendChild(label);
            entryDiv.appendChild(controlsDiv)

            const select = document.createElement("select");
            select.className = "form-control mb-2"
            select.name = "shareholders[]";

            // todo: add shareholder options

            const sharesInput = document.createElement("input")
            sharesInput.type = "number";
            sharesInput.className = "form-control"
            sharesInput.name = "shares[]";
            sharesInput.min = "1";
            sharesInput.placeholder = "enter an amount"

            const removeButton = document.createElement("button");
            removeButton.className = "btn-btn secondary";
            removeButton.textContent = "remove"
            removeButton.addEventListener("click", (event) => {
                event.preventDefault();
                entryDiv.remove();
                updateShares();
            })

            controlsDiv.appendChild(select);
            controlsDiv.appendChild(sharesInput);
            controlsDiv.appendChild(removeButton);

            return entryDiv;
        }

        function addShareholder() {
            const newEntry = createShareholderEntry();
            shareholdersContainer.appendChild(newEntry);
            console.log("hi")
        }

    </script>
{% endblock %}